<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Xam-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
    <meta name="viewport" content="width=device-width, target-densitydpi=device-dpi, initial-scale=1, maximum-scale=1, user-scalable=yes">
    <meta charset="UTF-8">

    <!-- polyfills -->
    <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>

    <script src="js/preload.js"></script>

    <link rel="stylesheet" href="bower_components/bulma/css/bulma.css">
    <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
    <title>AML Demo</title>
</head>
<body>
<!-- Loader view -->
<div id="preloader" class="container is-marginless is-fluid" style="background-color: white; top:0; position: absolute; width: 100%; height: 100%; text-align: center; padding-top: 13%; z-index: 1000">
    <h2 class="title is-2">Loading AML Demo</h2>
    <progress id="preloader-progress" class="progress is-info" value="0" max="100" style="margin-left: 25%; max-width: 50%">0%</progress>
    <img src="./images/powered_by_mulesoft.png">
</div>

<!-- Main container class -->
<link rel="import" href="vocabularies/nav.html">
<div class="section" style="padding: 0px">
    <div id="the-app" class="container is-marginless is-fluid">
        <div class="columns">
            <div class="column is-2" id="navigator-container" style="height: 100px">
                <link rel="import" href="vocabularies/navigator.html">
            </div>
            <div class="column" style="height: 100px">
                <link rel="import" href="vocabularies/editor_aml.html">
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        window.global = window;
        // ************
        // $URL will be replaced by the URL passed to the AMF requests
        // to form the final URL for the invocation throught the proxy
        // window.JS_USE_PROXY="https://mycorsproxy.com/$URL";
        // ************
        const loadApp = function(cb) {
            var assets = [
                "js/amf_playground_vocabs.js",
                "js/monaco-editor/min/vs/loader.js",
                "js/monaco-editor/monaco-customize.js"
            ];
            var loaded = 0;
            var preload = new createjs.LoadQueue();
            var handleFileComplete = function(event) {
                var oldValue = document.getElementById("preloader-progress").value;
                var newValue = Math.floor(oldValue + (100 / (loaded + assets.length)));
                document.getElementById("preloader-progress").value = newValue;
                document.body.appendChild(event.result);
                loaded++;
                if(assets.length == 0) {
                    document.getElementById("preloader-progress").value = 100;
                    cb();
                } else {
                    console.log("loading " + assets[0]);
                    preload.loadFile(assets.shift());
                }
            };
            preload.addEventListener("fileload", handleFileComplete);
            console.log("loading " + assets[0]);
            preload.loadFile(assets.shift());
        };

        window.addEventListener('WebComponentsReady', function() {
            document.getElementsByName("body");
            // Imported content
            window.reloadApp = function () {
                var importedMap = {};
                var pending = true;
                while (pending === true) {
                    pending = false;
                    var links = document.querySelectorAll('link[rel="import"]');
                    for (var i = 0; i < links.length; i++) {
                        var link = links[i];
                        if (link.import != null && importedMap[link.href] == null) {
                            pending = true;
                            importedMap[link.href] = true;
                            var content = link.import;
                            var el = content.querySelector('.imported');
                            link.parentNode.insertBefore(el.cloneNode(true), link);
                        }
                    }
                }

                require.config({paths: {'vs': 'js/monaco-editor/min/vs'}});
                require(['vs/editor/editor.main'], function () {

                    var resize = function () {
                        console.log("** Resizing **");
                        var height = document.documentElement.clientHeight;
                        var editorId = "editor-aml-container";
                        var containerDiv = document.getElementById(editorId);
                        var style = window.getComputedStyle(containerDiv);
                        var hidden = style.display == "none";
                        if (!hidden) {
                            containerDiv.setAttribute("style", "height: " + (height - 180) + "px");
                        }

                        var navigatorHeight = getHeight("navigator");
                        var navigatorContainerHeight = getHeight("navigator-container");

                        if(navigatorContainerHeight - navigatorHeight < 184) {
                            document.getElementById("navigator").style.height = (navigatorContainerHeight - 184) + "px";
                            document.getElementById("query").style.maxHeight = (navigatorContainerHeight - 184) + "px";
                        } else {
                            document.getElementById("navigator").style.height = "auto";
                            document.getElementById("query").style.maxHeight = "auto";
                        }

                        //document.getElementById("query").style.height = (height - ) + "px";
                        //document.getElementById("query").style.overflow = "scroll";
                    };

                    const getHeight = function(containerId) {
                        const containerDiv = document.getElementById(containerId);
                        const containerStyle = window.getComputedStyle(containerDiv);
                        const heightString = containerStyle.height;
                        const heightNumber = heightString.split("px")[0];
                        return Number(heightNumber);
                    };

                    window.onresize = resize;
                    window.resizeFn = resize;
                    resize();

                    customizeMonaco();

                    var editorData = monaco.editor.create(document.getElementById("editor-aml-container"), {
                        value: [
                            '# loading data'
                        ].join('\n'),
                        language: 'raml',
                        minimap: {
                            enabled: false
                        }
                    });


                    window.appModel = new amf_playground_vocabs.ViewModel(editorData);
                    window.appModel.apply(document.getElementById("the-app"));
                    setTimeout(function() {
                        document.getElementById("preloader").style.display = "none";
                        const brand = document.getElementById("brand");
                        if (brand) {
                            brand.style.display='block';
                        }
                    }, 200);
                });
            };

            console.log("** Loading first");
            loadApp(function(){
                reloadApp();
            });
        });
    })();
</script>
</body>
</html>