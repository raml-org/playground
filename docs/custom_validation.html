<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
    <meta name="viewport" content="width=device-width, target-densitydpi=device-dpi, initial-scale=1, maximum-scale=1, user-scalable=yes">
    <meta charset="UTF-8">

    <!-- polyfills -->
    <script src="bower_components/webcomponentsjs/webcomponents-loader.js"></script>

    <script src="js/preload.js"></script>
    <script src="js/monaco-customize.js"></script>

    <link rel="stylesheet" href="bower_components/bulma/css/bulma.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/validation_styles.css">
    <link rel="stylesheet" href="bower_components/font-awesome/css/all.min.css">
    <link rel="stylesheet" href="bower_components/balloon-css/balloon.css">
    <link rel="stylesheet" href="bower_components/jointjs/dist/joint.css">
    <title>Custom Validation</title>
</head>
<body>
<!-- Loader view -->
<div id="preloader" class="container is-marginless is-fluid" style="background-color: white; top:0; position: absolute; width: 100%; height: 100%; text-align: center; padding-top: 13%; z-index: 1000">
    <h2 class="title is-2">Loading Demo: Custom Validation</h2>
    <progress id="preloader-progress" class="progress is-info" value="0" max="100" style="margin-left: 25%; max-width: 50%">0%</progress>
</div>

<!-- Main container class -->
<link rel="import" href="html_fragments/custom_validation/nav.html">
<div class="section" style="padding: 0px">
    <div id="the-app" class="container is-marginless is-fluid">
        <div class="columns">
            <div class="column is-2" id="navigator-container">
                <link rel="import" href="html_fragments/custom_validation/navigator.html">
            </div>
            <div class="column">
                <link rel="import" href="html_fragments/custom_validation/editor_raml.html">
            </div>
            <div class="column">
                <link rel="import" href="html_fragments/custom_validation/editor_profile.html">
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        window.global = window;
        // ************
        // $URL will be replaced by the URL passed to the AMF requests
        // to form the final URL for the invocation throught the proxy
        // window.JS_USE_PROXY="https://mycorsproxy.com/$URL";
        // ************
        var loadApp = function(cb) {
            var assets = [
                "js/custom_validation.js",
                "js/monaco-editor/min/vs/loader.js"
            ];
            var loaded = 0;
            var preload = new createjs.LoadQueue();
            var handleFileComplete = function(event) {
                var oldValue = document.getElementById("preloader-progress").value;
                var newValue = Math.floor(oldValue + (100 / (loaded + assets.length)));
                document.getElementById("preloader-progress").value = newValue;
                document.body.appendChild(event.result);
                loaded++;
                if(assets.length == 0) {
                    document.getElementById("preloader-progress").value = 100;
                    cb();
                } else {
                    console.log("loading " + assets[0]);
                    preload.loadFile(assets.shift());
                }
            };
            preload.addEventListener("fileload", handleFileComplete);
            console.log("loading " + assets[0]);
            preload.loadFile(assets.shift());
        };

        window.addEventListener('WebComponentsReady', function() {
            document.getElementsByName("body");
            // Imported content
            window.reloadApp = function () {
                var importedMap = {};
                var pending = true;
                while (pending === true) {
                    pending = false;
                    var links = document.querySelectorAll('link[rel="import"]');
                    for (var i = 0; i < links.length; i++) {
                        var link = links[i];
                        if (link.import != null && importedMap[link.href] == null) {
                            pending = true;
                            importedMap[link.href] = true;
                            var content = link.import;
                            var el = content.querySelector('.imported');
                            link.parentNode.insertBefore(el.cloneNode(true), link);
                        }
                    }
                }

                require.config({paths: {'vs': 'js/monaco-editor/min/vs'}});
                require(['vs/editor/editor.main'], function () {

                    var resize = function () {
                        console.log("** Resizing **");
                        var height = document.documentElement.clientHeight;
                        var editors = ["editor-profile-container", "editor-raml-container"];
                        editors.forEach(function(editor) {
                            var containerDiv = document.getElementById(editor);
                            var style = window.getComputedStyle(containerDiv);
                            var hidden = style.display == "none";
                            if (!hidden) {
                                containerDiv.setAttribute("style", "height: " + (height - 180) + "px");
                            }
                        });

                        var navigatorHeight = getHeight("navigator");
                        var navigatorContainerHeight = getHeight("navigator-container");

                        if(navigatorContainerHeight - navigatorHeight < 154) {
                            document.getElementById("navigator").style.height = (navigatorContainerHeight - 154) + "px";
                        } else {
                            document.getElementById("navigator").style.height = "auto";
                        }

                        document.getElementById("shapes-list").style.height = (height - 180) + "px";
                        document.getElementById("shapes-list").style.overflow = "scroll";

                    };

                    var getHeight = function(containerId) {
                        var containerDiv = document.getElementById(containerId);
                        var containerStyle = window.getComputedStyle(containerDiv);
                        var heightString = containerStyle.height;
                        var heightNumber = heightString.split("px")[0];
                        return Number(heightNumber);
                    };

                    window.onresize = resize;
                    window.resizeFn = resize;
                    resize();

                    customizeMonaco();

                    var profileEditor = monaco.editor.create(document.getElementById("editor-profile-container"), {
                        language: 'raml',
                        automaticLayout: true,
                        scrollBeyondLastLine: false,
                        renderLineHighlight: "none",
                        occurrencesHighlight: false,
                        readOnly: false,
                        value: [
                            "#%Validation Profile 1.0\n" +
                            "\n" +
                            "profile: Test Profile\n" +
                            "\n" +
                            "description: A test custom validation profile\n" +
                            "\n" +
                            "extends: RAML\n" +
                            "\n" +
                            "disabled:\n" +
                            "  - contradiction\n" +
                            "  - all-properties-optional\n" +
                            "\n" +
                            "violation:\n" +
                            "  - mandatory-version\n" +
                            "  - version-format\n" +
                            "  - resource-camel-case-identifiers\n" +
                            "\n" +
                            "validations:\n" +
                            "\n" +
                            "  mandatory-version:\n" +
                            "    message: All APIs must have a version\n" +
                            "    targetClass: schema-org.WebAPI\n" +
                            "    propertyConstraints:\n" +
                            "      schema.version:\n" +
                            "        minCount: 1\n" +
                            "\n" +
                            "  version-format:\n" +
                            "    message: The version must be formatted as v[Major].[Minor] or v[Major], for example v2.3\n" +
                            "    targetClass: schema-org.WebAPI\n" +
                            "    propertyConstraints:\n" +
                            "      schema.version:\n" +
                            "        pattern: \"v[0-9]+(.[0-9]+)?\"\n" +
                            "\n" +
                            "  resource-camel-case-identifiers:\n" +
                            "    message: Identifiers must be camel-cased\n" +
                            "    targetClass: http.EndPoint\n" +
                            "    propertyConstraints:\n" +
                            "      schema.name:\n" +
                            "        pattern: \"[a-zA-Z]([A-Z0-9]*[a-z][a-z0-9]*[A-Z]|[a-z0-9]*[A-Z][A-Z0-9]*[a-z])[A-Za-z0-9]*\"\n" +
                            "\n" +
                            "  # just an example of JS validation\n" +
                            "  contradiction:\n" +
                            "    message: Fail always\n" +
                            "    targetClass: schema-org.WebAPI\n" +
                            "    functionConstraint:\n" +
                            "      code: |\n" +
                            "        function(resource) {\n" +
                            "          return false\n" +
                            "        }\n" +
                            "\n" +
                            "  all-properties-optional:\n" +
                            "    message: All properties in schemas must be optional\n" +
                            "    targetClass: shacl:PropertyShape\n" +
                            "    propertyConstraints:\n" +
                            "      shacl.minCount:\n" +
                            "        maxCount: 0"
                        ].join('\n'),
                        minimap: {
                            enabled: false
                        }
                    });

                    var ramlEditor = monaco.editor.create(document.getElementById("editor-raml-container"), {
                        automaticLayout: true,
                        language: 'raml',
                        scrollBeyondLastLine: false,
                        renderLineHighlight: "none",
                        occurrencesHighlight: false,
                        readOnly: false,
                        value: [
                            "#%RAML 1.0\n" +
                            "title: Mobile Order API\n" +
                            "version: \"1.0\"\n" +
                            "baseUri: http://localhost:8081/api\n" +
                            "protocols:\n" +
                            "  - ws\n" +
                            "types:\n" +
                            "  ProductItem:\n" +
                            "    type: object\n" +
                            "    additionalProperties: true\n" +
                            "    properties:\n" +
                            "      product_id:\n" +
                            "        required: true\n" +
                            "        type: string\n" +
                            "      quantity:\n" +
                            "        required: true\n" +
                            "        type: integer\n" +
                            "  Order:\n" +
                            "    type: object\n" +
                            "    additionalProperties: true\n" +
                            "    properties:\n" +
                            "      order_id:\n" +
                            "        required: true\n" +
                            "        type: string\n" +
                            "      creation_date:\n" +
                            "        required: true\n" +
                            "        type: string\n" +
                            "      items:\n" +
                            "        required: true\n" +
                            "        items:\n" +
                            "          type: object\n" +
                            "          additionalProperties: true\n" +
                            "          properties:\n" +
                            "            product_id:\n" +
                            "              required: true\n" +
                            "              type: string\n" +
                            "            quantity:\n" +
                            "              required: true\n" +
                            "              type: integer\n" +
                            "  Orders:\n" +
                            "    type: object\n" +
                            "    additionalProperties: true\n" +
                            "    properties:\n" +
                            "      orders:\n" +
                            "        required: true\n" +
                            "        items:\n" +
                            "          type: object\n" +
                            "          additionalProperties: true\n" +
                            "          properties:\n" +
                            "            order_id:\n" +
                            "              required: true\n" +
                            "              type: string\n" +
                            "            creation_date:\n" +
                            "              required: true\n" +
                            "              type: string\n" +
                            "            items:\n" +
                            "              required: true\n" +
                            "              items:\n" +
                            "                type: object\n" +
                            "                additionalProperties: true\n" +
                            "                properties:\n" +
                            "                  product_id:\n" +
                            "                    required: true\n" +
                            "                    type: string\n" +
                            "                  quantity:\n" +
                            "                    required: true\n" +
                            "                    type: integer\n" +
                            "traits:\n" +
                            "  paging:\n" +
                            "    queryParameters:\n" +
                            "      size:\n" +
                            "        description: the amount of elements of each result page\n" +
                            "        type: integer\n" +
                            "        required: false\n" +
                            "        example: 10\n" +
                            "      page:\n" +
                            "        description: the page number\n" +
                            "        type: integer\n" +
                            "        required: false\n" +
                            "        example: 0\n" +
                            "/orders:\n" +
                            "  displayName: get-orders\n" +
                            "  description: Orders collection resource used to create new orders.\n" +
                            "  get:\n" +
                            "    description: lists all orders of a specific user\n" +
                            "    queryParameters:\n" +
                            "      size:\n" +
                            "        description: the amount of elements of each result page\n" +
                            "        required: false\n" +
                            "        example: 10\n" +
                            "        type: integer\n" +
                            "      page:\n" +
                            "        description: the page number\n" +
                            "        required: false\n" +
                            "        example: 0\n" +
                            "        type: integer\n" +
                            "      userId:\n" +
                            "        type: string\n" +
                            "        description: use to query all orders of a user\n" +
                            "        required: true\n" +
                            "        example: 1964401a-a8b3-40c1-b86e-d8b9f75b5842\n" +
                            "    responses:\n" +
                            "      200:\n" +
                            "        body:\n" +
                            "          application/json:\n" +
                            "            type: object\n" +
                            "            examples:\n" +
                            "              single-order:\n" +
                            "                orders:\n" +
                            "                  -\n" +
                            "                    order_id: ORDER-437563756\n" +
                            "                    creation_date: 2016-03-30\n" +
                            "                    items:\n" +
                            "                      -\n" +
                            "                        product_id: PRODUCT-1\n" +
                            "                        quantity: 5\n" +
                            "                      -\n" +
                            "                        product_id: PRODUCT-2\n" +
                            "                        quantity: 2\n" +
                            "              multiple-orders:\n" +
                            "                orders:\n" +
                            "                  -\n" +
                            "                    order_id: ORDER-437563756\n" +
                            "                    creation_date: 2016-03-30\n" +
                            "                    items:\n" +
                            "                      -\n" +
                            "                        product_id: PRODUCT-1\n" +
                            "                        quantity: 5\n" +
                            "                      -\n" +
                            "                        product_id: PRODUCT-2\n" +
                            "                        quantity: 2\n" +
                            "                  -\n" +
                            "                    order_id: ORDER-437542111\n" +
                            "                    creation_date: 2016-03-30\n" +
                            "                    items:\n" +
                            "                      -\n" +
                            "                        product_id: PRODUCT-7\n" +
                            "                        quantity: 6\n" +
                            "            additionalProperties: true\n" +
                            "            properties:\n" +
                            "              orders:\n" +
                            "                required: true\n" +
                            "                items:\n" +
                            "                  type: object\n" +
                            "                  additionalProperties: true\n" +
                            "                  properties:\n" +
                            "                    order_id:\n" +
                            "                      required: true\n" +
                            "                      type: string\n" +
                            "                    creation_date:\n" +
                            "                      required: true\n" +
                            "                      type: string\n" +
                            "                    items:\n" +
                            "                      required: true\n" +
                            "                      items:\n" +
                            "                        type: object\n" +
                            "                        additionalProperties: true\n" +
                            "                        properties:\n" +
                            "                          product_id:\n" +
                            "                            required: true\n" +
                            "                            type: string\n" +
                            "                          quantity:\n" +
                            "                            required: true\n" +
                            "                            type: integer"
                        ].join('\n'),
                        language: 'raml',
                        minimap: {
                            enabled: false
                        }
                    });


                    window.appModel = new custom_validation.ViewModel(profileEditor, ramlEditor);
                    window.appModel.apply();
                    window.appModel.loadRamlFromQueryParam();

                    setTimeout(function() {
                        document.getElementById("preloader").style.display = "none";
                        var brand = document.getElementById("brand");
                        if (brand) {
                            brand.style.display='block';
                        }
                    }, 200);

                });
            };

            loadApp(function(){
                reloadApp();
            });
        });
    })();
</script>
</body>
</html>