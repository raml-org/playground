<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
    <meta name="viewport" content="width=device-width, target-densitydpi=device-dpi, initial-scale=1, maximum-scale=1, user-scalable=yes">
    <meta charset="UTF-8">

    <!-- polyfills -->
    <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>

    <script src="js/preload.js"></script>

    <link rel="stylesheet" href="bower_components/bulma/css/bulma.css">
    <link rel="stylesheet" href="css/vis.min.css">
    <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
    <title>RAML Diff</title>
</head>
<body>
<!-- Loader view -->
<div id="preloader" class="container is-marginless is-fluid" style="background-color: white; top:0; position: absolute; width: 100%; height: 100%; text-align: center; padding-top: 13%; z-index: 1000">
    <h2 class="title is-2">Loading RAML Diff Tool</h2>
    <progress id="preloader-progress" class="progress is-info" value="0" max="100" style="margin-left: 25%; max-width: 50%">0%</progress>
    <img src="./images/powered_by_mulesoft.png">
</div>

<!-- Main container class -->
<link rel="import" href="html_fragments/diff/nav.html">
<div class="section" style="padding: 0px">
    <div id="the-app" class="container is-marginless is-fluid">
        <div class="columns" data-bind="visible: editorSection()=='editor'">
            <div class="column">
                <link rel="import" href="html_fragments/diff/editor_left.html">
            </div>
            <div class="column">
                <link rel="import" href="html_fragments/diff/editor_right.html">
            </div>
        </div>
        <link rel="import" href="html_fragments/diff/panel.html">
        <link rel="import" href="html_fragments/diff/report.html">
        <link rel="import" href="html_fragments/diff/graph.html">
        <link rel="import" href="html_fragments/diff/modal.html">
    </div>
</div>

<script>
    (function() {
        window.global = window;
        var loadApp = function(cb) {
            var assets = [
                "js/amf_playground_diff.js",
                "js/monaco-editor/min/vs/loader.js",
                "js/monaco-editor/monaco-customize.js"
            ];
            var loaded = 0;
            var preload = new createjs.LoadQueue();
            var handleFileComplete = function(event) {
                var oldValue = document.getElementById("preloader-progress").value;
                var newValue = Math.floor(oldValue + (100 / (loaded + assets.length)));
                document.getElementById("preloader-progress").value = newValue;
                document.body.appendChild(event.result);
                loaded++;
                if(assets.length == 0) {
                    document.getElementById("preloader-progress").value = 100;
                    cb();
                } else {
                    console.log("loading " + assets[0]);
                    preload.loadFile(assets.shift());
                }
            };
            preload.addEventListener("fileload", handleFileComplete);
            console.log("loading " + assets[0]);
            preload.loadFile(assets.shift());
        };

        window.addEventListener('WebComponentsReady', function() {
            document.getElementsByName("body");
            // Imported content
            window.reloadApp = function () {
                var importedMap = {};
                var pending = true;
                while (pending === true) {
                    pending = false;
                    var links = document.querySelectorAll('link[rel="import"]');
                    for (var i = 0; i < links.length; i++) {
                        var link = links[i];
                        if (link.import != null && importedMap[link.href] == null) {
                            pending = true;
                            importedMap[link.href] = true;
                            var content = link.import;
                            var el = content.querySelector('.imported');
                            link.parentNode.insertBefore(el.cloneNode(true), link);
                        }
                    }
                }

                require.config({paths: {'vs': 'js/monaco-editor/min/vs'}});
                require(['vs/editor/editor.main'], function () {

                    var resize = function () {
                        console.log("** Resizing **");
                        var height = document.documentElement.clientHeight;
                        var editors = ["editor-left-container", "editor-right-container"];
                        editors.forEach(function(editor) {
                            var containerDiv = document.getElementById(editor);
                            var style = window.getComputedStyle(containerDiv);
                            var hidden = style.display == "none";
                            if (!hidden) {
                                containerDiv.setAttribute("style", "height: " + (height - 200) + "px");
                            }
                        });
                    };

                    var getHeight = function(containerId) {
                        var containerDiv = document.getElementById(containerId);
                        var containerStyle = window.getComputedStyle(containerDiv);
                        var heightString = containerStyle.height;
                        var heightNumber = heightString.split("px")[0];
                        return Number(heightNumber);
                    };

                    window.onresize = resize;
                    window.resizeFn = resize;
                    resize();

                    customizeMonaco();

                    var editorLeft = monaco.editor.create(document.getElementById("editor-left-container"), {
                        value: [
                            '#%RAML 1.0\n' +
                            '\n' +
                            'title: Uber API\n' +
                            'description: Move your app forward with the Uber API\n' +
                            'version: 1.2\n' +
                            'baseUri: api.uber.com/v12\n' +
                            '\n' +
                            'types:\n' +
                            '  Activity:\n' +
                            '    properties:\n' +
                            '      uuid:\n' +
                            '        required: false\n' +
                            '        type: string\n' +
                            '    \n' +
                            '/products:\n' +
                            '  get:\n' +
                            '    responses:\n' +
                            '      200:\n' +
                            '        body:\n' +
                            '          properties:\n' +
                            '            description: string'
                        ].join('\n'),
                        language: 'raml',
                        minimap: {
                            enabled: false
                        }
                    });

                    var editorRight = monaco.editor.create(document.getElementById("editor-right-container"), {
                        value: [
                            '#%RAML 1.0\n' +
                            '\n' +
                            'title: Uber API\n' +
                            'description: Move your app forward with the Uber API\n' +
                            'version: 1.3\n' +
                            'baseUri: api.uber.com/v13\n' +
                            '\n' +
                            'mediaType: application/json\n' +
                            'protocols: https\n' +
                            '\n' +
                            'types:\n' +
                            '  Activity:\n' +
                            '    properties:\n' +
                            '      uuid:\n' +
                            '        required: false\n' +
                            '        type: string\n' +
                            '  Error:\n' +
                            '    properties:\n' +
                            '      reason: string\n' +
                            '\n' +
                            '/history:\n' +
                            '  get:\n' +
                            '    description: "Paginated List of activities"\n' +
                            '    queryParameters:\n' +
                            '      limit: integer\n' +
                            '      offset: integer\n' +
                            '    responses:\n' +
                            '      200:\n' +
                            '        description: History information for the given user\n' +
                            '        body:\n' +
                            '          type: Activity\n' +
                            '      default:\n' +
                            '        description: Unexpected error\n' +
                            '        body:\n' +
                            '          type: Error\n' +
                            '/me:\n' +
                            '  get:\n' +
                            '    \n' +
                            '/products:\n' +
                            '  get:'
                        ].join('\n'),
                        language: 'raml',
                        minimap: {
                            enabled: false
                        }
                    });

                    window.appModel = new amf_playground_diff.ViewModel(editorLeft,editorRight);
                    window.appModel.apply(document.getElementById("the-app"));
                    setTimeout(function() {
                        document.getElementById("preloader").style.display = "none";
                        var brand = document.getElementById("brand");
                        if (brand) {
                            brand.style.display='block';
                        }
                    }, 200);

                });
            };

            loadApp(function(){
                reloadApp();
            });
        });
    })();
</script>
</body>
</html>