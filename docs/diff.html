<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
    <meta name="viewport" content="width=device-width, target-densitydpi=device-dpi, initial-scale=1, maximum-scale=1, user-scalable=yes">
    <meta charset="UTF-8">

    <!-- polyfills -->
    <script src="bower_components/webcomponentsjs/webcomponents-loader.js"></script>

    <script src="js/preload.js"></script>
    <script src="js/monaco-customize.js"></script>

    <link rel="stylesheet" href="bower_components/bulma/css/bulma.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="bower_components/font-awesome/css/all.min.css">
    <link rel="stylesheet" href="bower_components/balloon-css/balloon.css">
    <link rel="stylesheet" href="bower_components/jointjs/dist/joint.css">
    <title>Diff</title>
</head>
<body>
<!-- Loader view -->
<div id="preloader" class="container is-marginless is-fluid" style="background-color: white; top:0; position: absolute; width: 100%; height: 100%; text-align: center; padding-top: 13%; z-index: 1000">
    <h2 class="title is-2">Loading Demo: Diff</h2>
    <progress id="preloader-progress" class="progress is-info" value="0" max="100" style="margin-left: 25%; max-width: 50%">0%</progress>
</div>

<!-- Load RAML File modal -->
<link rel="import" href="html_fragments/load_modal.html">
<!-- Nav -->
<link rel="import" href="html_fragments/diff/nav.html">

<!-- Main container class -->
<div class="section" style="padding: 0px">
    <div id="the-app" class="container is-marginless is-fluid">
        <div class="columns">
            <div class="column">
                <link rel="import" href="html_fragments/diff/editor.html">
            </div>
        </div>
    </div>
</div>

<script>
  (function() {
    window.global = window;
    // ************
    // $URL will be replaced by the URL passed to the AMF requests
    // to form the final URL for the invocation throught the proxy
    // window.JS_USE_PROXY="https://mycorsproxy.com/$URL";
    // ************
    var loadApp = function(cb) {
      var assets = [
        "js/diff.js",
        "js/monaco-editor/min/vs/loader.js"
      ];
      var loaded = 0;
      var preload = new createjs.LoadQueue();
      var handleFileComplete = function(event) {
        var oldValue = document.getElementById("preloader-progress").value;
        var newValue = Math.floor(oldValue + (100 / (loaded + assets.length)));
        document.getElementById("preloader-progress").value = newValue;
        document.body.appendChild(event.result);
        loaded++;
        if (assets.length == 0) {
          document.getElementById("preloader-progress").value = 100;
          cb();
        } else {
          console.log("loading " + assets[0]);
          preload.loadFile(assets.shift());
        }
      };
      preload.addEventListener("fileload", handleFileComplete);
      console.log("loading " + assets[0]);
      preload.loadFile(assets.shift());
    };

    window.addEventListener('WebComponentsReady', function() {
      document.getElementsByName("body");
      // Imported content
      window.reloadApp = function() {
        var importedMap = {};
        var pending = true;
        while (pending === true) {
          pending = false;
          var links = document.querySelectorAll('link[rel="import"]');
          for (var i = 0; i < links.length; i++) {
            var link = links[i];
            if (link.import != null && importedMap[link.href] == null) {
              pending = true;
              importedMap[link.href] = true;
              var content = link.import;
              var el = content.querySelector('.imported');
              link.parentNode.insertBefore(el.cloneNode(true), link);
            }
          }
        }

        require.config({
          paths: {
            'vs': 'js/monaco-editor/min/vs'
          }
        });
        require(['vs/editor/editor.main'], function() {
          var resize = function() {
            var height = document.documentElement.clientHeight;
            var container
            container = document.getElementById("diff-editor-container");
            if (window.getComputedStyle(container).display !== "none") {
              container.style.height = (height - 130) + "px";
            }
          }


          window.onresize = resize;
          window.resizeFn = resize;
          resize();

          customizeMonaco();

          var diffEditor = monaco.editor.createDiffEditor(
            document.getElementById("diff-editor-container"), {
              originalEditable: true,
              scrollBeyondLastLine: false,
              renderLineHighlight: "none",
              occurrencesHighlight: false
            });
          diffEditor.setModel({
            original: monaco.editor.createModel("", "raml"),
            modified: monaco.editor.createModel("", "raml")
          });

          window.appModel = new diff.ViewModel(diffEditor);
          window.appModel.apply();
          window.appModel.loadRamlFromQueryParam();

          setTimeout(function() {
            document.getElementById("preloader").style.display = "none";
            var brand = document.getElementById("brand");
            if (brand) {
              brand.style.display = 'block';
            }
          }, 200);
        });
      };

      loadApp(function() {
        reloadApp();
      });
    });
  })();
</script>
</body>
</html>